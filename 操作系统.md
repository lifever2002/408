# OS

## 进程

### 结构

- 进程控制块（PCB）
  - 描述信息：进程标识符（PID），用户标识符（UID）
  - 控制管理信息：进程状态、CPU/硬盘/网络使用情况
  - 资源分配清单：文件、内存区域、IO设备
  - 处理机信息：PSW、PC等寄存器的值
- 程序段：程序代码（指令序列）
- 数据段：运行过程中的数据（程序中的变量）

### 控制：进程状态切换

- 创建
  - 创建原语（创建态→就绪态）：申请空白PCB→分配资源→初始化PCB→将PCB插入就绪队列
  - 事件：用户登录，作业调度，提供服务（用户请求），应用请求
- 阻塞
  - 阻塞原语（运行态→阻塞态）：从PCB集合中找到对应PCB→保护运行现场并暂停进程→将PCB插入阻塞队列
  - 事件：等待资源分配，等待其他进程
- 唤醒
  - 唤醒原语（阻塞态→就绪态）：从阻塞队列中找到对应PCB→将PCB移出阻塞队列→将PCB插入就绪队列
  - 事件：引起阻塞的原因消失
- 切换
  - 切换原语（进程1：运行态→，进程2：→运行态）：将进程1的运行环境信息（进程上下文/Context）存入PCB→将进程1的PCB插入对应队列→根据进程2的PCB恢复运行环境并运行
  - 事件：时间片到，更高优先级的进程到达，主动阻塞，终止
- 终止
  - 撤销原语：从PCB集合中找到对应PCB→若在运行剥夺CPU分配给其他进程→终止其所有子进程→将资源归还给父进程或OS→删除PCB
  - 事件：正常结束（exit系统调用），异常结束，外界干预（用户关闭）

### 调度：选择一个进程，切换到该进程

- 层次
  - 高级（作业）调度：从后备队列中选取作业调入内存，为其创建进程
    - 外存→内存，频率低
  - 中级（内存）调度：从挂起队列中选择进程调回内存
    - 挂起队列：暂不执行的进程被调入外存，变为就绪挂起/阻塞挂起状态
    - 外存→内存，频率中
  - 低级（进程）调度：从就绪队列中选择进程，为其分配处理机
    - 内存→CPU，频率高
- 评价指标
  - CPU利用率：忙碌时间 / 总时间
  - 系统吞吐量：完成的作业总数 / 总时间
  - 周转时间：作业完成时间 - 作业提交时间
    - 平均周转时间：周转时间之和 / 作业总数
    - 带权周转时间：周转时间 / 作业实际运行时间
    - 平均带权周转时间：带权周转时间之和 / 作业总数
  - 等待时间：等待处理机的时间之和，I/O时间不计入
  - 响应时间：从用户提交请求到首次产生响应所用的的时间
  - 响应比：(等待时间 + 要求服务时间) / 要求服务时间
- 方式
  - 抢占式（剥夺式）：由OS剥夺当前进程的CPU使用权
  - 非抢占式（非剥夺式）：等待当前进程主动放弃CPU
- 算法
  - 先来先服务（FCFS）：按照作业/进程到达的先后顺序进行服务
    - 公平，但对长作业有利，短作业不利
    - 非抢占式，不会饥饿
    - 只考虑等待时间
  - 短作业/进程优先（SJF/SPF）：选择要求服务时间最短的作业/进程进行服务
    - 最少的平均等待时间、最少的平均周转时间、最少的平均带权周转时间
    - 不公平，对短作业有利，长作业不利
    - 非抢占式，会饥饿（长作业/进程）
    - 只考虑运行时间
  - 最短剩余时间优先（SRTN）：SJF/SPF的抢占式版本
  - 高响应比优先（HRRN）:选择响应比最高的作业/进程进行服务
    - 非抢占式，不会饥饿
    - 同时考虑等待时间和运行时间
  -
  - 时间片轮转（RR）：
    - 只用于进程调度
    - 抢占式，不会饥饿
  - 优先级：
    - 抢占式/非抢占式，会饥饿（低优先级进程/作业）
  - 多级反馈队列：
    1. 多级就绪队列，优先级从高到低，时间片从小到大
    2. 新进程排在第1级队列队尾等待分配时间片，若时间片用完进程未结束，则排在下一级队列队尾。若已经位于最下级队列，则重新放回该队列队尾。
    3. 只有第k级队列为空时，才为第k+1级队列分配时间片
    - 只用于进程调度
    - 抢占式，会饥饿
  - 多级队列算法：按照进程类型设置多个队列
    - 各队列采取固定优先级、时间片划分
    - 各队列采用不同调度算法

### 同步互斥

### 通信（IPC）

- 共享存储
  - 原理：设置一块内存共享区，映射到进程的逻辑地址空间，各进程互斥访问（由进程实现）
  - 方式：基于数据结构（低级），基于存储区（高级）
- 消息传递：
  - 原理：OS提供发送/接收原语，传递结构化（消息头，消息体）的消息
  - 方式：直接通信（发送到接收进程的消息队列），间接通信（发送到信箱）
- 管道通信
  - 原理：设置一块内存缓冲区（半双工通信管道），各进程互斥访问（由OS实现：管道写满时写进程阻塞，管道读空时读进程阻塞）

### 线程

- 属性
  - 控制：线程控制块（TCB），就绪/阻塞/运行三态
    - TCB：线程标识符（TID），各种寄存器的值，堆栈指针，线程状态，优先级
  - 通信：线程几乎不拥有资源，进程内的线程共享进程的资源、通信无需系统干预
- 引入线程后的变化
  - 进程作为除了CPU之外的资源分配的基本单位，线程作为调度的基本单位
  - 进程内的线程之间可以并发，进程内的线程调度无需切换进程，开销减小
- 分类
  - 内核级线程：调度的基本单位，由OS实现，真正的线程
  - 用户级线程：将内核级线程再分，由线程库实现，虚拟的线程
  - 两者关系：一对一，一对多，N对M（N<M）

## 内存

## 文件

## I/O

## 其他

### 启动过程

1. CPU执行内存ROM区（BIOS）中的引导程序
2. 将主引导记录（MBR）读入内存，执行磁盘引导程序，扫描分区表
3. 将活动分区（系统盘主分区）中的分区引导记录（PBR）读入内存，执行程序
4. 执行系统盘根目录下的OS初始化程序（启动管理器）

### 中断：OS内核夺回CPU使用权的唯一途径

- 内中断（异常）：中断信号来源于CPU内部，与当前执行的指令有关，CPU在执行指令时检查
    陷入（trap）、故障、终止
- 外中断（中断）：中断信号来源于CPU外部，与当前执行的指令无关，CPU在指令周期末尾检查
    时钟中断、IO中断

### 系统调用

- 过程：传递系统调用参数→执行陷入指令（用户态）→执行内核程序处理系统调用（内核态）→返回应用程序
- 功能
  - 设备管理：设备的 请求/释放/启动
  - 文件管理：文件的 读/写/创建/删除
  - 进程控制：进程的 创建/撤销/阻塞/唤醒
  - 进程通信：进程之间的 消息传递/信号传递
  - 内存管理：内存的 分配/回收

### 其他概念

- 并发：宏观同时发生、微观交替发生
- 共享：资源共享、可供内存中的多个并发进程共同使用
- 虚拟：把一个物理上的实体变为若干个逻辑上的对应物
- 异步：多个程序并发执行，进程以不可预知的速度推进
